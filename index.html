<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Compiler</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #dropzone {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            cursor: pointer;
        }

        #downloadBtn, #compileBtn {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #downloadBtn:hover, #compileBtn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>

<input type="file" id="fileInput" style="display:none" onchange="handleFileSelection()" />

<div id="dropzone" onclick="openFileInput()">
    <p>Click here or drag and drop a file</p>
</div>

<button id="compileBtn" onclick="compileFile()">Compile</button>

<a id="downloadBtn" href="#" download="compiled.mind">Download compiled file</a>

<script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.5/dist/mindar-image.prod.js"></script>
<script>
    let selectedFile;

    function openFileInput() {
        document.getElementById('fileInput').click();
    }

    function handleFileSelection() {
        const fileInput = document.getElementById('fileInput');
        selectedFile = fileInput.files[0];

        if (selectedFile) {
            document.getElementById('dropzone').innerHTML = `<p>${selectedFile.name}</p>`;
            document.getElementById('compileBtn').style.display = 'block';
        }
    }

    async function compileFile() {
        const compiler = new window.MINDAR.IMAGE.Compiler();

        if (!selectedFile) {
            alert('Please select a file before compiling.');
            return;
        }

        try {
            const image = await loadImage(selectedFile);
            const dataList = await compiler.compileImageTargets([image], () => {}); // Add an empty callback
            const exportedBuffer = await compiler.exportData();
            enableDownloadButton(exportedBuffer);
        } catch (error) {
            console.error('Error during compilation:', error);
            alert('Error during compilation. Please try again.');
        }
    }

    function loadImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = reader.result;
            };
            reader.readAsDataURL(file);
        });
    }

    function enableDownloadButton(buffer) {
        const downloadBtn = document.getElementById('downloadBtn');
        downloadBtn.style.display = 'block';

        // Create a Blob from the buffer
        const blob = new Blob([buffer], { type: 'application/octet-stream' });

        // Set the download link's href to a URL created from the Blob
        downloadBtn.href = URL.createObjectURL(blob);
    }
</script>

</body>
</html>
